<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSCD211 Concept Map - D3.js Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        #graph {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .node {
            cursor: pointer;
            stroke-width: 2px;
        }
        
        .node.course { fill: #3498db; stroke: #2980b9; }
        .node.paradigm { fill: #e74c3c; stroke: #c0392b; }
        .node.language { fill: #2ecc71; stroke: #27ae60; }
        .node.concept { fill: #f39c12; stroke: #e67e22; }
        .node.skill { fill: #9b59b6; stroke: #8e44ad; }
        .node.structure { fill: #1abc9c; stroke: #16a085; }
        .node.algorithm { fill: #34495e; stroke: #2c3e50; }
        .node.tool { fill: #95a5a6; stroke: #7f8c8d; }
        
        .node:hover {
            stroke-width: 3px;
            stroke-opacity: 0.8;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .link.prerequisite { stroke: #e74c3c; stroke-width: 3px; }
        .link.enables { stroke: #3498db; stroke-width: 2px; }
        .link.part-of { stroke: #2ecc71; stroke-width: 2px; }
        .link.implements { stroke: #f39c12; stroke-width: 2px; }
        .link.related { stroke: #95a5a6; stroke-width: 1px; }
        .link.uses { stroke: #9b59b6; stroke-width: 1px; }
        
        .node-label {
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            dominant-baseline: central;
            fill: white;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            max-width: 250px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.2);
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .controls button {
            margin: 0 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSCD211 Concept Map</h1>
        <p class="subtitle">Interactive visualization of programming concepts and their relationships</p>
        
        <div class="controls">
            <button onclick="restartSimulation()">Restart Layout</button>
            <button onclick="centerGraph()">Center View</button>
            <button onclick="toggleLinks()">Toggle Links</button>
        </div>
        
        <svg id="graph"></svg>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db; border-color: #2980b9;"></div>
                <span>Course</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c; border-color: #c0392b;"></div>
                <span>Paradigm</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71; border-color: #27ae60;"></div>
                <span>Language</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12; border-color: #e67e22;"></div>
                <span>Concept</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6; border-color: #8e44ad;"></div>
                <span>Skill</span>
            </div>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        // Graph dimensions and setup
        const width = 1160;
        const height = 600;
        
        // Create SVG container
        const svg = d3.select("#graph")
            .attr("width", width)
            .attr("height", height);
        
        // Create main group for zoom/pan
        const mainGroup = svg.append("g").attr("class", "main-group");
        
        // Create groups for links and nodes
        const linkGroup = mainGroup.append("g").attr("class", "links");
        const nodeGroup = mainGroup.append("g").attr("class", "nodes");
        
        // Tooltip
        const tooltip = d3.select("#tooltip");
        
        // Simulation setup
        let simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => d.size + 5));
        
        // Global variables
        let graphData = null;
        let links = null;
        let nodes = null;
        let linksVisible = true;
        
        // Load and visualize data
        d3.json("concept-map.json").then(function(data) {
            console.log("Data loaded successfully:", data);
            graphData = data;
            createVisualization(data);
        }).catch(function(error) {
            console.error("Error loading data:", error);
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("fill", "#e74c3c")
                .text("Error loading concept-map.json: " + error.message);
        });
        
        function createVisualization(data) {
            console.log("Creating visualization with data:", data);
            console.log("Nodes:", data.nodes.length, "Links:", data.links.length);
            
            // Create links
            links = linkGroup.selectAll(".link")
                .data(data.links)
                .enter().append("line")
                .attr("class", d => `link ${d.type}`)
                .attr("stroke-width", d => d.strength ? d.strength * 3 : 2);
            
            console.log("Links created:", links.size());
            
            // Create nodes
            nodes = nodeGroup.selectAll(".node")
                .data(data.nodes)
                .enter().append("circle")
                .attr("class", d => `node ${d.group}`)
                .attr("r", d => d.size || 15)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .call(d3.drag()
                    .on("start", dragStarted)
                    .on("drag", dragged)
                    .on("end", dragEnded));
            
            console.log("Nodes created:", nodes.size());
            
            // Add labels
            const labels = nodeGroup.selectAll(".node-label")
                .data(data.nodes)
                .enter().append("text")
                .attr("class", "node-label")
                .text(d => {
                    // Truncate long names for display
                    return d.name.length > 15 ? d.name.substring(0, 15) + "..." : d.name;
                })
                .style("font-size", d => `${Math.max(10, (d.size || 15) * 0.8)}px`);
            
            console.log("Labels created:", labels.size());
            
            // Update simulation
            simulation.nodes(data.nodes);
            simulation.force("link").links(data.links);
            
            console.log("Simulation started");
            
            // Animation tick
            simulation.on("tick", function() {
                links
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                nodes
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });
        }
        
        // Event handlers
        function handleMouseOver(event, d) {
            // Show tooltip
            tooltip
                .style("opacity", 1)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .html(`
                    <strong>${d.name}</strong><br/>
                    <em>Type:</em> ${d.group}<br/>
                    ${d.description ? `<em>Description:</em> ${d.description}<br/>` : ''}
                    ${d.level !== undefined ? `<em>Level:</em> ${d.level}<br/>` : ''}
                    <em>ID:</em> ${d.id}
                `);
            
            // Highlight connected nodes
            const connectedNodes = new Set();
            const connectedLinks = new Set();
            
            links.each(function(link) {
                if (link.source.id === d.id || link.target.id === d.id) {
                    connectedNodes.add(link.source.id);
                    connectedNodes.add(link.target.id);
                    connectedLinks.add(link);
                }
            });
            
            // Highlight effects
            nodes.style("opacity", node => connectedNodes.has(node.id) ? 1 : 0.3);
            links.style("opacity", link => connectedLinks.has(link) ? 1 : 0.1);
        }
        
        function handleMouseOut(event, d) {
            // Hide tooltip
            tooltip.style("opacity", 0);
            
            // Reset highlighting
            nodes.style("opacity", 1);
            links.style("opacity", linksVisible ? 0.6 : 0);
        }
        
        // Drag handlers
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // Control functions
        function restartSimulation() {
            simulation.alpha(1).restart();
        }
        
        function centerGraph() {
            if (!nodeGroup.node()) return;
            
            const bounds = nodeGroup.node().getBBox();
            const fullWidth = bounds.width;
            const fullHeight = bounds.height;
            const widthScale = width / fullWidth;
            const heightScale = height / fullHeight;
            const scale = 0.8 * Math.min(widthScale, heightScale);
            const translate = [width / 2 - scale * (bounds.x + fullWidth / 2), 
                             height / 2 - scale * (bounds.y + fullHeight / 2)];
            
            mainGroup.transition()
                .duration(750)
                .attr("transform", `translate(${translate})scale(${scale})`);
        }
        
        function toggleLinks() {
            linksVisible = !linksVisible;
            links.transition()
                .duration(300)
                .style("opacity", linksVisible ? 0.6 : 0);
        }
        
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", function(event) {
                mainGroup.attr("transform", event.transform);
            });
        
        svg.call(zoom);
    </script>
</body>
</html>
